version: 2.1
orbs:
  node: circleci/node@1.1.6
jobs:
  build:
    docker:
      - image: openjdk:8-jdk
        user: root
      - image: mongo:latest
    working_directory: /go/src/duty-designator
    steps:
      - checkout
      - run: wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
      - run: echo "deb http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google.list
      - run: apt-get update
      - run: |
          apt-get install -y dbus-x11 google-chrome-stable libgtk2.0-0 \
          libnotify-dev \
          libgconf-2-4 \
          libnss3 \
          libxss1 \
          libasound2 \
          xvfb \
          gcc \
          libxml2-utils
      - run: rm -rf /var/lib/apt/lists/*
      - restore_cache:
          keys:
            - cache-{{ arch }}-{{ .Branch }}-{{ checksum "./e2e/package.json" }}
      - restore_cache:
          keys:
            - cache-3-{{ arch }}-{{ .Branch }}-{{ checksum "./server/gogradle.lock" }}
      - run: ./gradlew :server:goDependencies
      - save_cache:
          key: cache-3-{{ arch }}-{{ .Branch }}-{{ checksum "./server/gogradle.lock" }}
          paths:
            - ./server/vendor
            - ./server/.gogradle
      - run: ./gradlew :server:goTest
      - node/install-node
      - node/install-yarn
      - run: ./gradlew check
      - run: cd e2e && xmllint --xpath "/testsuites/@failures" results/test-output.xml | sed 's/failures="\([[:digit:]+]\)"/\1/' | awk '{exit $0}'
      - save_cache:
          key: cache-{{ arch }}-{{ .Branch }}-{{ checksum "./e2e/package.json" }}
          paths:
            - ~/.cache
      - store_artifacts:
          path: /go/src/duty-designator/server/.gogradle/reports
      - store_test_results:
          path: build/test-output
workflows:
  version: 2
  build_and_test:
    jobs:
      - build